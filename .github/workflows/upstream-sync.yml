# ====================================================================
# ğŸ”„ Simple Upstream Sync Workflow
# ====================================================================
# åŠŸèƒ½è¯´æ˜ï¼š
# - è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“çš„æ›´æ”¹åˆ°å½“å‰ fork
# - åŸºç¡€å†²çªæ£€æµ‹å’Œ Issue é€šçŸ¥
# - ç®€åŒ–çš„ keepalive æœºåˆ¶
# - é€‚åˆä¸ªäººé¡¹ç›®å’Œç®€å•éœ€æ±‚
# ====================================================================

name: ğŸ”„ Simple Upstream Sync

# ====================================================================
# è§¦å‘æ¡ä»¶é…ç½®
# ====================================================================
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC å‡Œæ™¨ 1 ç‚¹è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 1 * * *'
  
  # æ‰‹åŠ¨è§¦å‘ï¼šæ”¯æŒåœ¨ Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:

# ====================================================================
# ç¯å¢ƒå˜é‡é…ç½®
# ====================================================================
env:
  # ä¸Šæ¸¸ä»“åº“åœ°å€ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰
  # ğŸ”§ è¯·æ ¹æ®ä½ çš„å®é™…æƒ…å†µä¿®æ”¹è¿™ä¸ªå€¼
  UPSTREAM_REPO: 'xjh22222228/tomato-work'
  
  # ç›®æ ‡åˆ†æ”¯åç§°
  # ğŸ”§ å¦‚æœä½ çš„ä¸»åˆ†æ”¯ä¸æ˜¯ mainï¼Œè¯·ä¿®æ”¹ä¸ºå¯¹åº”çš„åˆ†æ”¯å
  TARGET_BRANCH: 'main'

# ====================================================================
# ä¸»è¦ä»»åŠ¡å®šä¹‰
# ====================================================================
jobs:
  sync:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # æƒé™é…ç½®ï¼šå®šä¹‰æ­¤ workflow éœ€è¦çš„æœ€å°æƒé™
    permissions:
      contents: write  # è¯»å†™ä»“åº“å†…å®¹ï¼ˆæäº¤ã€æ¨é€ï¼‰
      issues: write   # åˆ›å»ºå’Œç®¡ç† Issuesï¼ˆå†²çªé€šçŸ¥ï¼‰
    
    # ================================================================
    # æ‰§è¡Œæ­¥éª¤
    # ================================================================
    steps:
      # ============================================================
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      # ============================================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # ç¦ç”¨å‡­æ®æŒä¹…åŒ–ï¼Œæé«˜å®‰å…¨æ€§
          persist-credentials: false
          # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç¡®ä¿èƒ½æ­£ç¡®æ¯”è¾ƒæäº¤
          fetch-depth: 0
          # ä½¿ç”¨è‡ªå®šä¹‰ PAT tokenï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæƒé™
          token: ${{ secrets.GH_PAT }}

      # ============================================================
      # æ­¥éª¤ 2ï¼šé…ç½® Git èº«ä»½
      # ============================================================
      - name: ğŸ”§ Set Git identity
        run: |
          # ä½¿ç”¨å®˜æ–¹ GitHub Actions bot èº«ä»½
          # è¿™æ ·å¯ä»¥é¿å…ä½¿ç”¨ä¸ªäººèº«ä»½ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ============================================================
      # æ­¥éª¤ 3ï¼šè·å–ä¸Šæ¸¸ä»“åº“æ›´æ”¹
      # ============================================================
      - name: ğŸ“¡ Fetch upstream changes
        run: |
          echo "ğŸ“¡ Adding upstream and fetching changes..."
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“ä½œä¸ºè¿œç¨‹æº
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          # è·å–ä¸Šæ¸¸ä»“åº“çš„æ‰€æœ‰æ›´æ”¹
          git fetch upstream

      # ============================================================
      # æ­¥éª¤ 4ï¼šæ£€æŸ¥å˜æ›´å¹¶å°è¯•åˆå¹¶
      # ============================================================
      - name: ğŸ“Š Check for changes and merge
        id: sync
        run: |
          # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
          git checkout ${{ env.TARGET_BRANCH }}
          
          # è®¡ç®—ä¸Šæ¸¸æ–°å¢çš„æäº¤æ•°é‡
          upstream_commits=$(git rev-list --count HEAD..upstream/${{ env.TARGET_BRANCH }})
          echo "ğŸ” Found $upstream_commits new upstream commits"
          
          # å¦‚æœæœ‰ä¸Šæ¸¸æ›´æ”¹ï¼Œå°è¯•åˆå¹¶
          if [ "$upstream_commits" -gt 0 ]; then
            echo "ğŸ”„ Merging upstream changes..."
            
            # å°è¯•è‡ªåŠ¨åˆå¹¶ï¼Œå¦‚æœå¤±è´¥åˆ™è®°å½•å†²çªçŠ¶æ€
            if git merge upstream/${{ env.TARGET_BRANCH }}; then
              echo "âœ… Merge successful"
              echo "status=success" >> $GITHUB_OUTPUT
              echo "changes=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Merge failed - conflicts detected"
              echo "status=conflict" >> $GITHUB_OUTPUT
              echo "changes=false" >> $GITHUB_OUTPUT
              # å–æ¶ˆå¤±è´¥çš„åˆå¹¶ï¼Œä¿æŒä»“åº“çŠ¶æ€å¹²å‡€
              git merge --abort
            fi
          else
            echo "ğŸ“­ No upstream changes"
            echo "status=no_changes" >> $GITHUB_OUTPUT
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      # ============================================================
      # æ­¥éª¤ 5ï¼šå¤„ç†åˆå¹¶å†²çª
      # ============================================================
      - name: ğŸš¨ Create conflict issue
        # åªæœ‰åœ¨æ£€æµ‹åˆ°å†²çªæ—¶æ‰æ‰§è¡Œ
        if: steps.sync.outputs.status == 'conflict'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            // å®šä¹‰ Issue æ ‡é¢˜å’Œå†…å®¹
            const title = 'ğŸš¨ Upstream Sync Failed: Merge Conflicts';
            const body = `
            ## ğŸš¨ è‡ªåŠ¨åŒæ­¥å¤±è´¥
            
            **æ—¶é—´**: ${new Date().toISOString()}
            **åŸå› **: æ£€æµ‹åˆ°åˆå¹¶å†²çª
            
            ### ğŸ› ï¸ æ‰‹åŠ¨è§£å†³æ­¥éª¤ï¼š
            \`\`\`bash
            # 1. å…‹éš†ä»“åº“åˆ°æœ¬åœ°
            git clone ${{ github.server_url }}/${{ github.repository }}.git
            cd ${{ github.event.repository.name }}
            
            # 2. æ·»åŠ ä¸Šæ¸¸ä»“åº“
            git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
            git fetch upstream
            
            # 3. å°è¯•åˆå¹¶ï¼ˆä¼šæ˜¾ç¤ºå†²çªæ–‡ä»¶ï¼‰
            git merge upstream/${{ env.TARGET_BRANCH }}
            
            # 4. æ‰‹åŠ¨ç¼–è¾‘å†²çªæ–‡ä»¶ï¼Œè§£å†³å†²çªåï¼š
            git add .
            git commit -m "resolve merge conflicts"
            git push origin ${{ env.TARGET_BRANCH }}
            \`\`\`
            
            ---
            *ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
            `;
            
            // åˆ›å»º Issue é€šçŸ¥ç”¨æˆ·
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['sync-conflict', 'help-wanted']
            });

      # ============================================================
      # æ­¥éª¤ 6ï¼šå‘¨æœ« Keepalive æœºåˆ¶
      # ============================================================
      - name: ğŸ«€ Weekly keepalive
        # åªæœ‰åœ¨æ— ä¸Šæ¸¸å˜æ›´æ—¶æ‰è€ƒè™‘ keepalive
        if: steps.sync.outputs.status == 'no_changes'
        run: |
          # è·å–å½“å‰æ˜¯æ˜ŸæœŸå‡ ï¼ˆ1=å‘¨ä¸€, 7=å‘¨æ—¥ï¼Œä½¿ç”¨ UTC æ—¶é—´ï¼‰
          # åªåœ¨å‘¨æ—¥åˆ›å»º keepaliveï¼Œé¿å…è¿‡äºé¢‘ç¹
          if [ "$(date -u +%u)" -eq 7 ]; then
            echo "ğŸ«€ Creating weekly keepalive commit..."
            # ä½¿ç”¨ç©ºæäº¤ä¿æŒä»“åº“æ´»è·ƒï¼Œé˜²æ­¢ GitHub Actions è¢«ç¦ç”¨
            # ç©ºæäº¤ä¸ä¼šæ”¹å˜ä»£ç ï¼Œåªæ˜¯ä¸ºäº†ç»´æŒæ´»è·ƒçŠ¶æ€
            git commit --allow-empty -m "chore: weekly keepalive $(date -u +%Y-%m-%d)"
            echo "keepalive=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Skipping keepalive (not Sunday)"
            echo "keepalive=false" >> $GITHUB_OUTPUT
          fi

      # ============================================================
      # æ­¥éª¤ 7ï¼šæ¨é€æ›´æ”¹åˆ°ä»“åº“
      # ============================================================
      - name: ğŸš€ Push changes
        # æ¡ä»¶ï¼šæœ‰æˆåŠŸçš„åˆå¹¶ æˆ– åˆ›å»ºäº† keepalive æäº¤
        if: steps.sync.outputs.changes == 'true' || env.keepalive == 'true'
        run: |
          echo "ğŸš€ Pushing changes..."
          # ä½¿ç”¨ PAT token æ¨é€æ›´æ”¹
          # æ ¼å¼ï¼šhttps://x-access-token:TOKEN@github.com/OWNER/REPO.git
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git HEAD:${{ env.TARGET_BRANCH }}
          echo "âœ… Push completed"

      # ============================================================
      # æ­¥éª¤ 8ï¼šç”Ÿæˆè¿è¡Œæ‘˜è¦
      # ============================================================
      - name: ğŸ“‹ Summary
        # æ€»æ˜¯æ‰§è¡Œï¼Œæ— è®ºå‰é¢æ­¥éª¤æˆåŠŸæˆ–å¤±è´¥
        if: always()
        run: |
          # ç”Ÿæˆæ ¼å¼åŒ–çš„çŠ¶æ€æŠ¥å‘Š
          # åŒ…å«å…³é”®ä¿¡æ¯ï¼šæ—¶é—´ã€ä»“åº“ã€çŠ¶æ€ã€keepalive ç­‰
          echo "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘           ğŸ”„ SYNC SUMMARY               â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ ğŸ“… Time: $(date -u '+%Y-%m-%d %H:%M:%S')
          â•‘ ğŸ¯ Repo: ${{ env.UPSTREAM_REPO }}
          â•‘ ğŸ“Š Status: ${{ steps.sync.outputs.status || 'unknown' }}
          â•‘ ğŸ«€ Keepalive: ${keepalive:-false}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          "
